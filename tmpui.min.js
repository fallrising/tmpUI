/**
 * tmpUI.js
 * version: 6
 * Github : https://github.com/tmplink/tmpUI
 * Date : 2021-1-7
 */
"use strict";function _instanceof(t,e){return null!=e&&"undefined"!=typeof Symbol&&e[Symbol.hasInstance]?!!e[Symbol.hasInstance](t):t instanceof e}function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function _classCallCheck(t,e){if(!_instanceof(t,e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function _createClass(t,e,i){return e&&_defineProperties(t.prototype,e),i&&_defineProperties(t,i),t}function _defineProperty(t,e,i){return e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}var tmpUI=function(){function t(e){var i=this;_classCallCheck(this,t),_defineProperty(this,"status",{}),_defineProperty(this,"config",{}),_defineProperty(this,"version",0),_defineProperty(this,"index","/"),_defineProperty(this,"debug",!0),_defineProperty(this,"dynamicRouter",null),_defineProperty(this,"language_config",!1),_defineProperty(this,"language_data",!1),_defineProperty(this,"language_setting","en"),_defineProperty(this,"loadDelay",500),_defineProperty(this,"loadCallback",[]),_defineProperty(this,"readyFunction",[]),_defineProperty(this,"loadingPageInit",!1),_defineProperty(this,"loadingPage",!1),_defineProperty(this,"loadingIcon",!1),_defineProperty(this,"loadingText","Loading..."),_defineProperty(this,"readyCallback",null),_defineProperty(this,"progress_enable",!0),_defineProperty(this,"progress_status",!1),_defineProperty(this,"animation_time",500),_defineProperty(this,"animation_stime",0),_defineProperty(this,"onExitfunction",[]),this.state={displayTrophy:!0},window.tmpui_helper={loadQueue:0,loadTotal:0,readyQueue:0,readyTotal:0},this.loadConfig(e,function(t){history.replaceState(i.state,null,""),i.config=i.rebuildConfig(t),i.rebuildRunConfig(),i.route(),window.addEventListener("popstate",function(t){i.route()})})}return _createClass(t,[{key:"onExit",value:function(t){this.onExitfunction.push(t)}},{key:"doExit",value:function(){if(0!==this.onExitfunction.length){for(var t in this.onExitfunction)this.onExitfunction[t]();this.onExitfunction=[]}}},{key:"ready",value:function(t){this.readyFunction.push(t)}},{key:"readyExec",value:function(){if(0!==this.readyFunction.length){for(var t in this.readyFunction)this.readyFunction[t]();this.readyFunction=[]}}},{key:"readyEvent",value:function(){var t=this;window.tmpui_helper.readyQueue==window.tmpui_helper.readyTotal?(this.readyExec(),this.log("Ready")):setTimeout(function(){t.readyEvent()},1e3)}},{key:"loadConfig",value:function(t,e){var i=new XMLHttpRequest,n={},a=t+"?"+Date.parse(new Date);i.onreadystatechange=function(){4==this.readyState&&200==this.status&&(n=JSON.parse(this.responseText),e(n))},i.open("GET",a,!0),i.send()}},{key:"rebuildRunConfig",value:function(t){void 0!==this.config.loadingPage&&(this.loadingPage=this.config.loadingPage),void 0!==this.config.loadingText&&(this.loadingText=this.config.loadingText),void 0!==this.config.loadingIcon&&(this.loadingIcon=this.config.loadingIcon),void 0!==this.config.version&&(this.version=this.config.version),void 0!==this.config.language&&(this.language_config=this.config.language),void 0!==this.config.loadingProgress&&(this.progress_enable=this.config.loadingProgress),void 0!==this.config.loadingAnimationTime&&(this.animation_time=this.config.loadingAnimationTime),void 0!==this.config.dynamicRouter&&(this.dynamicRouter=this.config.dynamicRouter),void 0!==this.config.pageNotFound&&(this.pageNotFound=this.config.pageNotFound)}},{key:"rebuildConfig",value:function(t){if(void 0!==t.path)for(var e in t.path){if(t.path[e].res={},void 0!==t.path[e].preload)for(var i in t.path[e].preload){var n=t.path[e].preload[i];for(var a in t.preload[n])t.path[e].res[a]={},t.path[e].res[a]=t.preload[n][a]}if(void 0!==t.path[e].body)for(var o in t.path[e].body)t.path[e].res[o]=t.path[e].body[o];if(void 0!==t.path[e].append)for(var r in t.path[e].append){var s=t.path[e].append[r];for(var l in t.append[s])t.path[e].res[l]={},t.path[e].res[l]=t.append[s][l]}}return t.reload_table={},t}},{key:"linkRebind",value:function(){var t=this,e=document.getElementsByTagName("a");if(e.length>0)for(var i in e)if("object"===_typeof(e[i])){if("PRE"===e[i].parentNode.nodeName||"CODE"===e[i].parentNode.nodeName)continue;"true"==e[i].getAttribute("tmpui-app")&&"true"!=e[i].getAttribute("tmpui-app-rebind")&&function(){var n="",a=e[i].getAttribute("href").split("?");n=1===a.length?t.index+"?tmpui_page="+a[0]:t.index+"?tmpui_page="+a[0]+"&"+a[1],e[i].setAttribute("tmpui-app-rebind","true"),e[i].setAttribute("href",n),e[i].addEventListener("click",function(e){e.preventDefault(),history.pushState({newPage:n},null,n),t.route()})}()}var n=document.getElementsByTagName("code");if(n.length>0)for(var a in n){if("object"===_typeof(n[a]))if("true"==n[a].getAttribute("tmpui-html-code")){var o=n[a].innerHTML;n[a].innerHTML=o.toString().replace(/[<>&"]/g,function(t){return{"<":"&lt;",">":"&gt;","&":"&amp;",'"':"&quot;"}[t]}),n[a].setAttribute("tmpui-html-code","loaded")}}return"ok"}},{key:"autofix",value:function(){if(""!==this.config.siteroot){var t=this.config.siteroot;$("[tmpui-root]").each(function(){var e=$(this).attr("tmpui-root"),i=$(this).attr("src"),n=$(this).attr("href");"true"===e&&null!=i&&($(this).attr("src",t+i),$(this).attr("tmpui-root","false")),"true"===e&&null!=n&&($(this).attr("href",t+n),$(this).attr("tmpui-root","false"))})}}},{key:"open",value:function(t){var e=this.index+"?tmpui_page="+t;history.pushState({newPage:e},null,e),this.route()}},{key:"route",value:function(){var t,e=this,i="/";if(void 0!==(t=this.getUrlVars(window.location.href)).tmpui_page&&(i=t.tmpui_page),$(".tmpUIRes").remove(),this.loadpage(!0),void 0===this.config.path[i]){if(null!==this.dynamicRouter){var n=this.config.siteroot+this.dynamicRouter+i+".json",a=new XMLHttpRequest;return a.onreadystatechange=function(){4!=a.readyState||200!=a.status&&304!=a.status||(e.config.path[i]=JSON.parse(a.responseText),e.rebuildConfig(e.config),e.route_core(i)),4!=a.readyState||404!=a.status&&403!=a.status||e.route_unfound(i)},a.open("GET",n+"?v="+this.version,!0),a.send(),!0}return this.route_unfound(i),!1}this.route_core(i)}},{key:"route_core",value:function(t){var e=this;this.loaderStart(t,function(){document.title=e.config.path[t].title,e.draw(t),e.autofix(),e.linkRebind(),setTimeout(function(){e.loadpage(!1)},e.loadDelay)})}},{key:"route_unfound",value:function(t){return null!==this.pageNotFound&&(console.log(this.pageNotFound),this.route_core(this.pageNotFound)),this.log("page not found : "+t),!1}},{key:"draw",value:function(t){for(var e in this.config.path[t].res){if("js"===this.config.path[t].res[e].type){var i=this.config.path[t].res[e].dom;!1===this.config.path[t].res[e].reload?!1===this.config.reload_table[e]&&(this.config.reload_table[e]=!0,window.tmpui_helper.readyTotal++,$("body").append('<script class="tmpUIRes_once" type="text/javascript" ">\n'+i+"\nwindow.tmpui_helper.readyQueue++;<\/script>\n")):(window.tmpui_helper.readyTotal++,$("body").append('<script class="tmpUIRes" type="text/javascript" ">\n'+i+"\nwindow.tmpui_helper.readyQueue++;<\/script>\n"))}if("js-es6"===this.config.path[t].res[e].type){var n=Babel.transform(this.config.path[t].res[e].dom,{presets:["es2015","stage-3"]}).code;!1===this.config.path[t].res[e].reload?!1===this.config.reload_table[e]&&(this.config.reload_table[e]=!0,window.tmpui_helper.readyTotal++,$("body").append('<script class="tmpUIRes_once" type="text/javascript" ">\n'+n+"\nwindow.tmpui_helper.readyQueue++;<\/script>\n")):(window.tmpui_helper.readyTotal++,$("body").append('<script class="tmpUIRes" type="text/javascript" ">\n'+n+"\nwindow.tmpui_helper.readyQueue++;<\/script>\n"))}if("css"===this.config.path[t].res[e].type&&(!1===this.config.path[t].res[e].reload?!1===this.config.reload_table[e]&&(this.config.reload_table[e]=!0,$("head").append('<link class="tmpUIRes_once" rel="stylesheet" href="'+e+"?v="+this.config.version+'" >\n')):$("head").append('<link class="tmpUIRes" rel="stylesheet" href="'+e+"?v="+this.config.version+'" >\n')),"tpl"===this.config.path[t].res[e].type){var a=this.config.path[t].res[e].dom;!1===this.config.path[t].res[e].reload?!1===this.config.reload_table[e]&&(this.config.reload_table[e]=!0,$("body").append('<div class="tmpUIRes_once" style="display:none" ">\n'+a+"</div>\n")):$("body").append('<div class="tmpUIRes" style="display:none" ">\n'+a+"</div>\n")}if("html"===this.config.path[t].res[e].type){if("append"===this.config.path[t].res[e].target.type){var o=this.config.path[t].res[e].dom;$("#tmpui_body").append(o)}if("body"===this.config.path[t].res[e].target.type){var r=this.config.path[t].res[e].dom;$("#tmpui_body").html(r)}if("id"===this.config.path[t].res[e].target.type){var s=this.config.path[t].res[e].target.val,l=this.config.path[t].res[e].dom;$("#"+s).replaceWith(l)}}this.log(e)}!1!==this.language_config&&this.language_build(),this.readyEvent()}},{key:"loaderStart",value:function(t,e){for(var i in this.loadCallback=e,console.log(t),this.config.path[t].res)window.tmpui_helper.loadTotal++;for(var n in this.config.path[t].res)this.loaderUnit(t,n)}},{key:"loaderUnit",value:function(t,e){var i=this;if(void 0===this.config.path[t].res[e].state&&(this.config.path[t].res[e].state=0,this.config.path[t].res[e].dom=0),!1===this.config.path[t].res[e].reload&&void 0===this.config.reload_table[e]&&(this.config.reload_table[e]=!1),1===this.config.path[t].res[e].state)window.tmpui_helper.loadQueue++,this.loaderFinish();else{var n=new XMLHttpRequest;n.onreadystatechange=function(){4==n.readyState&&200==n.status&&(window.tmpui_helper.loadQueue++,i.config.path[t].res[e].state=1,i.config.path[t].res[e].dom=n.responseText,i.loaderFinish())},n.open("GET",e+"?v="+this.version,!0),n.send()}}},{key:"loaderFinish",value:function(){this.progress_enable&&!1===this.progress_status&&(this.progress_status=!0,this.animation_slice(),$("#tmpui_loading_show").append('<div class="tmpui_progress tmpui_round_conner" id="tmpui_loading_progress"><div class="tmpui_curRate tmpui_round_conner"></div></div>')),this.log("Queue:"+window.tmpui_helper.loadTotal+"|Finish:"+window.tmpui_helper.loadQueue);var t=Math.ceil(window.tmpui_helper.loadQueue/window.tmpui_helper.loadTotal*100);$(".tmpui_curRate").animate({width:t+"%"},this.animation_stime,function(){100===t&&($("#tmpui_loading_progress").fadeOut(),$("body").css("overflow",""),$("#tmpui").fadeOut())}),window.tmpui_helper.loadQueue==window.tmpui_helper.loadTotal&&(this.log("Queue:"+window.tmpui_helper.loadTotal+"|Finish:"+window.tmpui_helper.loadQueue),"function"==typeof this.loadCallback&&this.loadCallback(),this.loadCallback=null,this.progress_status=!0)}},{key:"animation_slice",value:function(){window.tmpui_helper.loadTotal>1?this.animation_stime=Math.ceil(this.animation_time/window.tmpui_helper.loadTotal):this.animation_stime=this.animation_time,this.log("Animation slice time: "+this.animation_stime+" ,total: "+this.animation_time)}},{key:"title",value:function(t){$("title").html(t)}},{key:"language_set",value:function(t){if(localStorage.getItem("language")===t)return!1;localStorage.setItem("language",t),this.language_build()}},{key:"language_get",value:function(){return localStorage.getItem("language")}},{key:"language_build",value:function(){var t=this,e=localStorage.getItem("language");if(this.log("language setting...."+e),null===e){var i=navigator.language;this.language_setting="en","zh-CN"!==i&&"zh-SG"!==i&&"zh"!==i||(this.language_setting="cn"),"zh-TW"!==i&&"zh-HK"!==i||(this.language_setting="hk"),"ja"!==i&&"ja-JP"!==i||(this.language_setting="jp"),"ru"!==i&&"ru-MI"!==i||(this.language_setting="ru"),"ko"===i&&(this.language_setting="kr"),"ms"===i&&(this.language_setting="my"),localStorage.setItem("language",this.language_setting)}else this.language_setting=e;window.tmpui_helper.readyTotal++,$.get(this.language_config[this.language_setting]+"?v="+this.version,function(e){window.tmpui_helper.readyQueue++,t.language_data=e;var i={};null!=e&&(i=e),$("[i18n]").each(function(t){var e=$(this).attr("i18n-only");null!=$(this).val()&&""!=$(this).val()&&(null!=e&&null!=e&&""!=e&&"value"!=e||$(this).val(i[$(this).attr("i18n")])),null!=$(this).html()&&""!=$(this).html()&&(null!=e&&null!=e&&""!=e&&"html"!=e||$(this).html(i[$(this).attr("i18n")])),null!=$(this).attr("placeholder")&&""!=$(this).attr("placeholder")&&(null!=e&&null!=e&&""!=e&&"placeholder"!=e||$(this).attr("placeholder",i[$(this).attr("i18n")])),null!=$(this).attr("content")&&""!=$(this).attr("content")&&(null!=e&&null!=e&&""!=e&&"content"!=e||$(this).attr("content",i[$(this).attr("i18n")])),null!=$(this).attr("title")&&""!=$(this).attr("title")&&(null!=e&&null!=e&&""!=e&&"title"!=e||$(this).attr("title",i[$(this).attr("i18n")]))})},"json")}},{key:"description",value:function(t){$("meta[name=description]").attr("content",t)}},{key:"loadpage",value:function(t){if(!this.loadingPage)return this.log("Loading page exit."),this.ready_exec(),!1;if(this.loadingPageInit||($("#tmpui").append('<div id="tmpui_loading_bg" style="background-color: rgba(255, 255, 255, 0.8);-webkit-backdrop-filter:saturate(180%) blur(20px);backdrop-filter: saturate(180%) blur(20px);"></div>'),$("#tmpui_loading_bg").append('<div id="tmpui_loading_show"></div>'),$("#tmpui_loading_show").append('<div style="text-align:center;margin-bottom:20px;" id="tmpui_loading_content"></div>'),!1!==this.loadingIcon?$("#tmpui_loading_content").append('<img src="'+this.loadingIcon+'" style="vertical-align: middle;border-style: none;width:129px;height:129px;"/>'):$("#tmpui_loading_content").append('<div style="text-align:center;font-family: fa5-proxima-nova,"Helvetica Neue",Helvetica,Arial,sans-serif;">'+this.loadingText+"</div>"),this.loadingPageInit=!0,this.log("Loading page created.")),t)$("body").css("overflow","hidden"),$("#tmpui").show(),this.doExit(),this.log("Loading page on");else{if(this.log("Loading page off"),this.progress_enable)return!0;$("body").css("overflow",""),$("#tmpui").fadeOut()}}},{key:"tpl",value:function(t,e){var i=$("#"+t).html();return this.TemplateEngine(i,e)}},{key:"TemplateEngine",value:function(t,e){if(""==t||null==t)return console.error("TemplateEngine::Html can't be null."),"";for(var i,n,a=/<%(.+?)%>/g,o=/(^( )?(var|if|for|else|switch|case|break|{|}|;))(.*)?/g,r="with(obj) { var r=[];\n",s=0,l=function t(e,i){return r+=i?e.match(o)?e+"\n":"r.push("+e+");\n":""!=e?'r.push("'+e.replace(/"/g,'\\"')+'");\n':"",t};n=a.exec(t);)l(t.slice(s,n.index))(n[1],!0),s=n.index+n[0].length;l(t.substr(s,t.length-s)),r=(r+'return r.join(""); }').replace(/[\r\t\n]/g," ");try{i=new Function("obj",r).apply(e,[e])}catch(t){console.error("'"+t.message+"'"," in \n\nCode:\n",r,"\n")}return i}},{key:"getUrlVars",value:function(t){var e={};t.replace(/[?&]+([^=&]+)=([^&]*)/gi,function(t,i,n){e[i]=n});return e}},{key:"log",value:function(t){this.debug&&console.log(t)}}]),t}();